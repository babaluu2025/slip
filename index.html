<script>
  let currentWaiter = null;
  let data = JSON.parse(localStorage.getItem("konobariData") || "{}");
  let clearTimer = null;

  if(Object.keys(data).length === 0){
    for(let i=1;i<=15;i++){ 
      data["Konobar "+i] = { expr:"", total:0, numbers:[] }; 
    }
    saveData();
  }

  function saveData(){ localStorage.setItem("konobariData", JSON.stringify(data)); }

  function showScreen(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function loadWaiters(){
    let list=document.getElementById("waiterList");
    list.innerHTML="";
    for(let name in data){
      let btn=document.createElement("button");
      btn.className="btn";
      btn.innerText=name+" ("+(data[name].total || 0)+")";
      
      btn.onclick=()=>openCalc(name);
      btn.oncontextmenu=(e)=>{
        e.preventDefault();
        let newName=prompt("Novo ime za " + name, name);
        if(newName && !data[newName]){
          data[newName]=data[name];
          delete data[name];
          saveData();
          loadWaiters();
        } else if(newName && data[newName]){
          alert("To ime ve캖 postoji!");
        }
      };
      list.appendChild(btn);
    }
  }

  function openCalc(name){
    currentWaiter=name;
    document.getElementById("waiterName").innerText=name;
    document.getElementById("display").innerText=data[name].expr || "0";
    showScreen("calc");
  }

  function press(val){
    let expr=data[currentWaiter].expr || "";
    expr+=val;
    data[currentWaiter].expr=expr;
    document.getElementById("display").innerText=expr;
  }

  // 游댳 Novi sistem za brisanje
  function clearDisplay(shortPress = true){
    if(shortPress){
      // obri코i poslednji znak
      let expr = data[currentWaiter].expr;
      if(expr.length > 0){
        expr = expr.slice(0, -1);
        data[currentWaiter].expr = expr;
        document.getElementById("display").innerText = expr || "0";
      }
    } else {
      // dug pritisak bri코e sve
      data[currentWaiter].expr = "";
      data[currentWaiter].total = 0;
      data[currentWaiter].numbers = [];
      document.getElementById("display").innerText = "0";
    }
    saveData();
  }

  function safeEval(expr){
    let result = Function('"use strict";return (' + expr + ')')();
    return Math.round(result * 100) / 100;
  }

  function calcResult(){
    try {
      let expr = data[currentWaiter].expr;
      let res = safeEval(expr);
      data[currentWaiter].total = res;
      let nums = expr.match(/\d+(\.\d+)?/g) || [];
      data[currentWaiter].numbers = nums.map(n=>parseFloat(n));
      document.getElementById("display").innerText=res;
      saveData();
    } catch(e){ alert("Gre코ka u izrazu"); }
  }

  function goHome(){ showScreen("home"); loadWaiters(); saveData(); }

  function openManager(){
    let rep="";
    let numMap={};
    for(let name in data){
      let nums = data[name].numbers || [];
      rep+=`<p><b>${name}:</b> ${data[name].total} (${nums.join(", ")})</p>`;
      nums.forEach(n=>{
        if(!numMap[n]) numMap[n]=[];
        if(!numMap[n].includes(name)) numMap[n].push(name);
      });
    }
    rep+="<h3>Duplikati brojeva:</h3>";
    for(let num in numMap){
      if(numMap[num].length>1){
        rep+=`<p class="highlight">Broj ${num} kod: ${numMap[num].join(", ")}</p>`;
      }
    }
    document.getElementById("report").innerHTML=rep;
    showScreen("manager");
  }

  function resetAll(){
    if(confirm("Da li sigurno 쬰li코 obrisati sve?")){
      for(let name in data){ data[name]={expr:"", total:0, numbers:[]}; }
      saveData(); goHome();
    }
  }

  // PWA registracija
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js'); });
  }

  loadWaiters();

  // 游댳 Dodajemo "short/long press" detekciju na C dugme
  window.addEventListener('load', ()=>{
    const cBtn = document.querySelector('button[onclick="clearDisplay()"]');
    if(cBtn){
      cBtn.addEventListener('touchstart', ()=>{ clearTimer=setTimeout(()=>clearDisplay(false),700); });
      cBtn.addEventListener('touchend', ()=>{
        if(clearTimer){ clearTimeout(clearTimer); clearDisplay(true); }
      });
      cBtn.addEventListener('mousedown', ()=>{ clearTimer=setTimeout(()=>clearDisplay(false),700); });
      cBtn.addEventListener('mouseup', ()=>{
        if(clearTimer){ clearTimeout(clearTimer); clearDisplay(true); }
      });
    }
  });
</script>
